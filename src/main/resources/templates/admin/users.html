<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management</title>
  <link rel="stylesheet" th:href="@{/css/tailwind.css}">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .sidebar-link.active {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
      border-right: 3px solid #3b82f6;
    }
    
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .btn-gradient:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }

    /* Simple table hover */
    .table-row:hover {
      background-color: #f8fafc;
    }

    /* Role badges */
    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    /* Action buttons */
    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      gap: 0.375rem;
    }

    /* Search bar */
    .search-container {
      position: relative;
    }
    .search-container input:focus {
      outline: none;
      border-color: #3b82f6;
    }
  </style>
</head>

<body class="bg-gray-50">
  <!-- Main Container -->
  <div class="flex min-h-screen">
    <div th:replace="~{layout/adminSidebar :: sidebar}"></div>

    <main class="flex-1">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b px-8 py-4 sticky top-0 z-40">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
            <p class="text-gray-600">Welcome back, Administrator</p>
          </div>
          <div class="flex items-center space-x-4">
            <a href="/logout" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
              <i class="fas fa-sign-out-alt"></i>
              Logout
            </a>
          </div>
        </div>
      </header>

      <!-- Content Area -->
      <div class="p-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 font-medium">Total Users</p>
                <p class="text-3xl font-bold text-gray-800 mt-2" th:text="${#lists.size(users)}">0</p>
              </div>
              <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-users text-2xl text-blue-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 font-medium">Active</p>
                <p class="text-3xl font-bold text-green-600 mt-2" 
                   th:text="${#lists.size(users.?[status == 'ACTIVE'])}">0</p>
              </div>
              <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-user-check text-2xl text-green-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 font-medium">Pending</p>
                <p class="text-3xl font-bold text-yellow-600 mt-2" 
                   th:text="${#lists.size(users.?[status == 'PENDING'])}">0</p>
              </div>
              <div class="w-14 h-14 bg-yellow-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-user-clock text-2xl text-yellow-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 font-medium">Inactive</p>
                <p class="text-3xl font-bold text-gray-600 mt-2" 
                   th:text="${#lists.size(users.?[status == 'INACTIVE'])}">0</p>
              </div>
              <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-user-slash text-2xl text-gray-600"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
          <!-- Card Header -->
          <div class="px-6 py-5 border-b border-gray-100">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                  <i class="fas fa-users-cog text-blue-600"></i>
                  User Management
                </h2>
                <p class="text-sm text-gray-600 mt-1">Manage system users and permissions</p>
              </div>

              <div class="flex flex-col sm:flex-row gap-3">
                <!-- Search Bar -->
                <div class="search-container">
                  <input type="text" 
                         id="searchInput"
                         placeholder="Search users..." 
                         class="w-full sm:w-64 pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                  <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                </div>

                <!-- Add Button -->
                <button id="openCreateUser"
                        class="btn-gradient text-white px-5 py-2.5 rounded-lg font-medium flex items-center justify-center gap-2 hover:shadow-lg transition-all">
                  <i class="fas fa-user-plus"></i>
                  <span>Create User</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Table Container -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-hashtag text-gray-400"></i>
                      ID
                    </div>
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-user-circle text-gray-400"></i>
                      User
                    </div>
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-envelope text-gray-400"></i>
                      Email
                    </div>
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-user-tag text-gray-400"></i>
                      Role
                    </div>
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-info-circle text-gray-400"></i>
                      Status
                    </div>
                  </th>
                  <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    <div class="flex items-center justify-center gap-2">
                      <i class="fas fa-cog text-gray-400"></i>
                      Actions
                    </div>
                  </th>
                </tr>
              </thead>

              <tbody id="userTableBody">
                <!-- User Row -->
                <tr th:each="u : ${users}" class="table-row border-b border-gray-100">
                  <!-- ID -->
                  <td class="px-6 py-4">
                    <span class="text-gray-600 font-medium" th:text="${u.id}">1</span>
                  </td>

                  <!-- User Info (Profile + Name + Username) -->
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                      <img th:src="${u.userImage != null ? u.userImage : 'https://image2url.com/r2/default/images/1766936428388-02d719cb-dd68-42e4-9d9e-77743ecb9589.png'}"
                           alt="Profile"
                           class="w-10 h-10 rounded-full border-2 border-gray-200 object-cover">
                      <div>
                        <div class="font-semibold text-gray-800" th:text="${u.fullName}">John Doe</div>
                        <div class="text-xs text-gray-500" th:text="'@' + ${u.username}">@johndoe</div>
                      </div>
                    </div>
                  </td>

                  <!-- Email -->
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-envelope text-gray-400 text-sm"></i>
                      <span class="text-gray-700" th:text="${u.email}"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e78d888f89a7829f868a978b82c984888a">[email&#160;protected]</a></span>
                    </div>
                  </td>

                  <!-- Role -->
                  <td class="px-6 py-4">
                    <span th:if="${u.role == 'ADMIN'}" class="role-badge bg-blue-100 text-blue-700">
                      <i class="fas fa-user-shield"></i>
                      Admin
                    </span>
                    <span th:if="${u.role == 'LECTURER'}" class="role-badge bg-orange-100 text-orange-700">
                      <i class="fas fa-chalkboard-teacher"></i>
                      Lecturer
                    </span>
                    <span th:if="${u.role == 'STUDENT'}" class="role-badge bg-cyan-100 text-cyan-700">
                      <i class="fas fa-user-graduate"></i>
                      Student
                    </span>
                  </td>

                  <!-- Status -->
                  <td class="px-6 py-4">
                    <span th:if="${u.status == 'ACTIVE'}" class="status-badge bg-green-100 text-green-700">
                      <i class="fas fa-check-circle"></i>
                      Active
                    </span>
                    <span th:if="${u.status == 'INACTIVE'}" class="status-badge bg-gray-100 text-gray-700">
                      <i class="fas fa-ban"></i>
                      Inactive
                    </span>
                    <span th:if="${u.status == 'PENDING'}" class="status-badge bg-yellow-100 text-yellow-700">
                      <i class="fas fa-clock"></i>
                      Pending
                    </span>
                    <span th:if="${u.status == 'SUSPENDED'}" class="status-badge bg-red-100 text-red-700">
                      <i class="fas fa-exclamation-circle"></i>
                      Suspended
                    </span>
                  </td>

                  <!-- Actions -->
                  <td class="px-6 py-4">
                    <div class="flex items-center justify-center gap-2">
                      <!-- Toggle Status -->
                      <form th:action="@{/admin/users/{id}/status(id=${u.id})}"
                            method="post"
                            class="inline">
                        <button type="submit"
                                class="action-btn"
                                th:classappend="${u.status == 'ACTIVE'} ? 'bg-gray-100 text-gray-700 hover:bg-gray-200' : 'bg-green-100 text-green-700 hover:bg-green-200'">
                          <i th:class="${u.status == 'ACTIVE'} ? 'fas fa-ban' : 'fas fa-check'"></i>
                          <span th:text="${u.status == 'ACTIVE'} ? 'Deactivate' : 'Activate'">Activate</span>
                        </button>
                      </form>

                      <!-- Delete -->
                      <form th:action="@{/admin/users/{id}/delete(id=${u.id})}"
                            method="post"
                            class="inline"
                            onsubmit="return confirm('Are you sure you want to delete this user?');">
                        <button type="submit"
                                class="action-btn bg-red-100 text-red-700 hover:bg-red-200">
                          <i class="fas fa-trash-alt"></i>
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>

                <!-- Empty State -->
                <tr th:if="${#lists.isEmpty(users)}">
                  <td colspan="6" class="px-6 py-12">
                    <div class="flex flex-col items-center">
                      <i class="fas fa-users-slash text-6xl text-gray-300 mb-4"></i>
                      <h3 class="text-xl font-semibold text-gray-600 mb-2">No Users Found</h3>
                      <p class="text-gray-400 mb-4">Get started by creating your first user</p>
                      <button onclick="document.getElementById('openCreateUser').click()" 
                              class="btn-gradient text-white px-6 py-2.5 rounded-lg font-medium flex items-center gap-2">
                        <i class="fas fa-user-plus"></i>
                        Create First User
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Table Footer -->
          <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-600">
                Showing <span class="font-semibold text-gray-800" id="resultCount" th:text="${#lists.size(users)}">0</span> 
                of <span class="font-semibold text-gray-800" th:text="${#lists.size(users)}">0</span> users
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL CONTAINER -->
  <div id="createUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"></div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // Modal functionality
    document.getElementById('openCreateUser').addEventListener('click', function() {
      const modal = document.getElementById('createUserModal');

      fetch('/admin/users/create')
        .then(response => response.text())
        .then(html => {
          modal.innerHTML = html;
          modal.classList.remove('hidden');

          const closeBtn = modal.querySelector('#closeModal');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              modal.classList.add('hidden');
              modal.innerHTML = '';
            });
          }

          // Close on outside click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.add('hidden');
              modal.innerHTML = '';
            }
          });
        })
        .catch(error => {
          console.error('Error loading modal:', error);
          alert('Failed to load the form. Please try again.');
        });
    });

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('userTableBody');
    const resultCount = document.getElementById('resultCount');

    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = tableBody.querySelectorAll('tr:not([th\\:if])');
      let visibleCount = 0;

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      resultCount.textContent = visibleCount;

      // Show/hide search empty state
      const existingSearchEmpty = tableBody.querySelector('.search-empty');
      
      if (visibleCount === 0 && searchTerm.length > 0) {
        // Create search empty state if it doesn't exist
        if (!existingSearchEmpty) {
          const emptyRow = document.createElement('tr');
          emptyRow.className = 'search-empty';
          emptyRow.innerHTML = `
            <td colspan="6" class="px-6 py-12">
              <div class="flex flex-col items-center">
                <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No Results Found</h3>
                <p class="text-gray-400">Try adjusting your search terms</p>
              </div>
            </td>
          `;
          tableBody.appendChild(emptyRow);
        }
      } else {
        // Remove search empty state if it exists
        if (existingSearchEmpty) {
          existingSearchEmpty.remove();
        }
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        document.getElementById('openCreateUser').click();
      }
    });
  </script>

</body>
</html>